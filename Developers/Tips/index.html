

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tips &mdash; Xmipp 1.0.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=9edc463e" />
      <link rel="stylesheet" type="text/css" href="../../_static/custom.css" />

  
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=8d563738"></script>
      <script src="../../_static/doctools.js?v=9a2dae69"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Code documentation" href="../CodeDocumentation/index.html" />
    <link rel="prev" title="Guidelines" href="../Guidelines/index.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            Xmipp
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Installing Xmipp</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Installation/Requirements/index.html">Requirements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Installation/Installations/index.html">Installations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Installation/Optionals/index.html">Optional Tools and Libraries</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Installation/Troubleshooting/index.html">Troubleshooting</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Releases</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Releases/Releases-xmipp-program/index.html">Releases xmipp program</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Releases/Releases-scipion-em-xmipp/index.html">Releases scipion-em-xmipp</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Releases/Releases-scipion-em-xmippTomo/index.html">Releases scipion-em-xmippTomo</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Xmipp World</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../protocolsMap.html">Protocols Map</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../thePowerOfXmipp.html">The power of Xmipp</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../listOfPublications.html">List of Publications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../history.html">Timeline of Xmipp</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Utils</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Utils/ConfigurationF/index.html">Configuration File</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Utils/xmippStructure/index.html">Xmipp structure</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Utils/Conventions/index.html">Conventions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Utils/Deprecated-programs/index.html">Programs deprecated</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developers</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../Welcome-developers/index.html">Welcome Developers! üëã</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Guidelines/index.html">Guidelines</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Tips</a></li>
<li class="toctree-l1"><a class="reference internal" href="../CodeDocumentation/index.html">Code documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../UsefulScripts/index.html">Useful Tricks and Scripts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../HowToRelease2.0/index.html">Xmipp Release Procedures</a></li>
<li class="toctree-l1"><a class="reference internal" href="../How-to-release/index.html">Creating an Xmipp Release (Deprecated on v4)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Others</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Others/Enhancing/index.html">Data Collection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Others/Contact/index.html">Contact us</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Others/License/index.html">License</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Xmipp</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content style-external-links">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Tips</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/Developers/Tips/index.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="tips">
<h1>Tips<a class="headerlink" href="#tips" title="Link to this heading">ÔÉÅ</a></h1>
<p class="rubric">Checkout to a Specific Version</p>
<p>If you need to revert to a specific version of Xmipp or its associated repositories based on a particular date, you can achieve this using Git. This is useful, for example, when you encounter a new bug that was not present in an earlier version or when you have a long-lived branch in Xmipp that needs to be synchronized with a specific historical state.</p>
<p>Here is a step-by-step guide on how to accomplish this:</p>
<ol class="arabic">
<li><p><strong>Identify the Date</strong>: Determine the date of the version you want to revert to. In the following example, we‚Äôll use ‚Äú2020-09-27 08:57:42‚Äù as an example date.</p></li>
<li><p><strong>Checkout a Specific Commit</strong>: Use the following command to checkout the latest commit on the ‚Äúdevel‚Äù branch before the specified date:</p>
<p><a href="#id1"><span class="problematic" id="id2">``</span></a><cite>bash
git checkout `git rev-list -n 1 ‚Äìfirst-parent ‚Äìbefore=‚Äù2020-09-27 08:57:42‚Äù devel</cite></p>
</li>
</ol>
<p class="rubric">Integrating with Visual Studio Code</p>
<p>The CMake based installation script can be tightly integrated with any modern IDE. This section shows the procedure for Visual Studio Code (VSCode).</p>
<p>Before starting with the configuration process open a terminal and run the following commands. Anotate their outputs.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>conda<span class="w"> </span>activate<span class="w"> </span>scipion3<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="nv">$CONDA_PREFIX</span>
scipion3<span class="w"> </span>printenv<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>SCIPION_SOFTWARE
</pre></div>
</div>
<p><strong>In visual studio code</strong></p>
<blockquote>
<div><ol class="arabic">
<li><p>In the ‚ÄúExtensions‚Äù tab install ‚ÄúC/C++ Extension Pack‚Äù.</p></li>
<li><p>File -&gt; Open Folder -&gt; Navigate to ‚Äúxmipp‚Äù directory (previously cloned).</p></li>
<li><p>Click ‚ÄúYes, I trust the authors‚Äù.</p></li>
<li><p>File -&gt; Save workspace as‚Ä¶ -&gt; Select a directory outside the Xmipp folder.</p></li>
<li><p>Go to 5. File -&gt; Preferences -&gt; Configuration</p></li>
<li><p>Select the ‚ÄúWorkspace‚Äù tab</p></li>
<li><p>Navigate to the ‚ÄúCMake Tools‚Äù section</p></li>
<li><dl>
<dt>Set the following options</dt><dd><p>‚ÄúCmake: Configure Args‚Äù add -DCMAKE_PREFIX_PATH=CONDA_PREFIX (replace CONDA_PREFIX with the value obtained previously)</p>
<p>‚ÄúCmake: Configure Args‚Äù add -DCMAKE_SKIP_RPATH=ON</p>
<p>‚ÄúCmake: Configure Environment‚Äù add: Element: Python3_ROOT_DIR Value: CONDA_PREFIX (replace CONDA_PREFIX with the value obtained previously)</p>
<p>‚ÄúCmake: Configure Environment‚Äù add: Element: SCIPION_SOFTWARE Value: SCIPION_SOFTWARE (replace SCIPION_SOFTWARE with the value obtained previousy)</p>
<p>‚ÄúCmake: Install prefix‚Äù: /path-to/xmipp/dist (Absolute path)</p>
</dd>
</dl>
</li>
<li><p>Go to the CMake tab on the left.</p></li>
<li><p>In ‚ÄúPinned commands‚Äù add ‚ÄúInstall‚Äù</p></li>
</ol>
</div></blockquote>
<p>Once VS Code is set up, the Xmipp installation process can be launched though the newly pinned ‚ÄúInstall‚Äù command. In addition, individual files or sub-projects may be compiled for quick assessment of code.</p>
<p class="rubric">Parallel Programming</p>
<p><strong>Introduction</strong></p>
<p>In the simplest sense, <strong>parallel computing</strong> is the simultaneous use of
multiple compute resources to solve a computational problem:</p>
<ul class="simple">
<li><p>To be run using multiple CPUs</p></li>
<li><p>A problem is broken into discrete parts that can be solved
concurrently</p></li>
<li><p>Each part is further broken down to a series of instructions</p></li>
<li><p>Instructions from each part execute simultaneously on different CPUs</p></li>
</ul>
<p>The compute resources might be:</p>
<ul class="simple">
<li><p>A single computer with multiple processors (using of <strong>threads</strong>);</p></li>
<li><p>An arbitrary number of computers connected by a network(using
parallel library like <strong>MPI</strong>);</p></li>
<li><p>A combination of both.</p></li>
</ul>
<p>The computational problem should be able to:</p>
<ul class="simple">
<li><p>Be broken apart into discrete pieces of work that can be solved
simultaneously;</p></li>
<li><p>Execute multiple program instructions at any moment in time;</p></li>
<li><p>Be solved in less time with multiple compute resources than with a
single compute resource.</p></li>
</ul>
<p>In <strong>Xmipp3.0</strong> we have develop several classes to make easier the use
of threads and MPI when developing parallel programs. If you want to
read more about parallel computing there is a nice introduction
<a class="reference external" href="https://computing.llnl.gov/tutorials/parallel_comp/">here</a>. ## Task
distribution</p>
<p>One of the first steps in designing a parallel program is to break the
problem into discrete ‚Äúchunks‚Äù of work that can be distributed to
multiple tasks. This is known as decomposition or partitioning. There
are two basic ways to partition computational work among parallel tasks:
the data is partitioned or the work to be done.</p>
<p>In image processing for <em>single particles</em> on electron microscopy we
usually deal with several thousands of images, so the most common and
easy way to distribute is by data. Then each CPU take care of some part
of the data to perform processing tasks.</p>
<p>We have create the class <strong>[[ParallelTaskDistributor]]</strong> which have the
function to distribute N tasks (without knowing what each ‚Äútask‚Äù really
means) between a group of workers (threads or MPI). Each worker will ask
for a some tasks, process it and ask for more tasks until there is
nothing to be done. The following are several subclasses of
<a class="reference external" href="http://xmipp.cnb.uam.es/~xmipp/trunk/xmipp/documentation/html/classParallelTaskDistributor">ParallelTaskDistributor</a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//...</span>
<span class="o">//</span> <span class="n">Create</span> <span class="n">a</span> <span class="n">task</span> <span class="n">distributor</span> <span class="k">with</span> <span class="n">N</span> <span class="n">total</span> <span class="n">task</span> <span class="ow">and</span> <span class="n">serve</span> <span class="mi">10</span> <span class="n">on</span> <span class="n">each</span> <span class="n">request</span>
<span class="n">ParallelTaskDistributor</span> <span class="o">*</span> <span class="n">td</span> <span class="o">=</span> <span class="n">new</span> <span class="n">ThreadTaskDistributor</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
<span class="o">//...</span>
<span class="o">//</span><span class="n">function</span> <span class="n">to</span> <span class="n">perform</span> <span class="n">some</span> <span class="n">operation</span>
<span class="o">//</span><span class="n">to</span> <span class="n">N</span> <span class="n">images</span> <span class="n">executed</span> <span class="ow">in</span> <span class="n">parellel</span>
<span class="n">void</span> <span class="n">processSeveralImages</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">size_t</span> <span class="n">firstImage</span><span class="p">,</span> <span class="n">lastImage</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">td</span><span class="o">-&gt;</span><span class="n">getTasks</span><span class="p">(</span><span class="n">firstImage</span><span class="p">,</span> <span class="n">lastImage</span><span class="p">))</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">size_t</span> <span class="n">image</span> <span class="o">=</span> <span class="n">firstImage</span><span class="p">;</span> <span class="n">image</span> <span class="o">&lt;=</span> <span class="n">lastImage</span><span class="p">;</span> <span class="o">++</span><span class="n">image</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="o">//...</span>
            <span class="n">processOneImage</span><span class="p">(</span><span class="n">image</span><span class="p">);</span>
            <span class="o">//...</span>
        <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>Using threads</strong></p>
<p>Technically, a <strong>thread</strong> is defined as an independent stream of
instructions that can be scheduled to run as such by the operating
system. Before understanding a thread, one first needs to understand a
UNIX process. A process is created by the operating system, and requires
a fair amount of ‚Äúoverhead‚Äù. Processes contain information about program
resources and program execution state, including: Process ID, process
group ID, user ID, and group ID, environment, working directory, program
instructions, registers, stack, heap, file descriptors, signal actions,
shared libraries, inter-process communication tools (such as message
queues, pipes, semaphores, or shared memory). Threads use and exist
within these process resources, yet are able to be scheduled by the
operating system and run as independent entities largely because they
duplicate only the bare essential resources that enable them to exist as
executable code.</p>
<p>So, in summary, in the UNIX environment a thread:</p>
<ul class="simple">
<li><p>Exists within a process and uses the process resources</p></li>
<li><p>Has its own independent flow of control as long as its parent process
exists and the OS supports it</p></li>
<li><p>Duplicates only the essential resources it needs to be independently
schedulable</p></li>
<li><p>May share the process resources with other threads that act equally
independently (and dependently)</p></li>
<li><p>Dies if the parent process dies - or something similar</p></li>
<li><p>Is ‚Äúlightweight‚Äù because most of the overhead has already been
accomplished through the creation of its process.</p></li>
</ul>
<p>Because threads within the same process share resources:</p>
<ul class="simple">
<li><p>Changes made by one thread to shared system resources (such as
closing a file) will be seen by all other threads.</p></li>
<li><p>Two pointers having the same value point to the same data.</p></li>
<li><p>Reading and writing to the same memory locations is possible, and
therefore requires explicit synchronization by the programmer.</p></li>
</ul>
<p>A more detailed explanation about use of POSIX threads can be found
¬†here. ### Creating threads and passing parameters</p>
<p>Imagine that you have a program that perform tasks <em>A</em>, <em>B</em> and <em>C</em>, and
tasks <em>A</em> and <em>C</em> task can be threaded. So, task <em>A</em> can be splited in
several concurrent tasks <em>A1, A2, A3‚Ä¶An</em> and the same for C. In the
following figure you can see the serial and threaded version of the
program execution:</p>
<p>This type of threading now can be easily done using the following
classes:</p>
<ul class="simple">
<li><p><em>[[ThreadManager]]</em> will create the threads and run diffent functions
in parallel</p></li>
<li><p><em>[[ThreadFunction]]</em> prototype of function that can be runned by
<em>[[ThreadManager]]</em>.</p></li>
<li><p>Its definition is typedef void( <strong>[[ThreadFunction]] )(ThreadArgument
&amp;arg) typedef void(</strong> [[ThreadFunction]] )(ThreadArgument &amp;arg)</p></li>
<li><p><em>[[ThreadArgument]]</em>: Argument type that is passed to
<em>[[ThreadFunction]]</em>. It contains:</p></li>
<li><p>thread_id: number identifying each thread</p></li>
<li><p>data: void * pointer to pass additional information</p></li>
<li><p>workClass: void * pointer to hold a reference to working class</p></li>
</ul>
<p>The previous example can be coded:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="n">void</span> <span class="o">*</span> <span class="n">functionA</span><span class="p">(</span><span class="n">ThreadArgument</span> <span class="o">&amp;</span> <span class="n">data</span><span class="p">)</span>
 <span class="p">{</span>
     <span class="o">//...</span>
 <span class="p">}</span>
  <span class="n">void</span> <span class="o">*</span> <span class="n">functionB</span><span class="p">()</span>
 <span class="p">{</span>
     <span class="o">//...</span>
 <span class="p">}</span>
  <span class="n">void</span> <span class="o">*</span> <span class="n">functionC</span><span class="p">(</span><span class="n">ThreadArgument</span> <span class="o">&amp;</span> <span class="n">data</span><span class="p">)</span>
 <span class="p">{</span>
     <span class="o">//...</span>
 <span class="p">}</span>

 <span class="nb">int</span> <span class="n">main</span><span class="p">()</span>
 <span class="p">{</span>
 <span class="o">//</span><span class="n">Start</span> <span class="mi">4</span> <span class="n">threads</span> <span class="n">to</span> <span class="n">work</span>
 <span class="n">ThreadManager</span> <span class="o">*</span> <span class="n">tm</span> <span class="o">=</span> <span class="n">new</span> <span class="n">ThreadManager</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
 <span class="o">//</span> <span class="n">Run</span> <span class="ow">in</span> <span class="n">parallel</span> <span class="n">functionA</span>
 <span class="n">tm</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">functionA</span><span class="p">);</span>
 <span class="o">//</span> <span class="n">All</span> <span class="n">threads</span> <span class="n">are</span> <span class="n">syncronized</span> <span class="n">at</span> <span class="n">this</span> <span class="n">point</span>
 <span class="n">functionB</span><span class="p">();</span>
 <span class="o">//</span><span class="n">If</span> <span class="n">you</span> <span class="n">need</span> <span class="n">to</span> <span class="k">pass</span> <span class="n">some</span> <span class="n">additional</span> <span class="n">information</span>
<span class="o">//</span> <span class="n">to</span> <span class="n">work</span> <span class="n">on</span> <span class="n">functionB</span> <span class="n">you</span> <span class="n">can</span> <span class="n">do</span><span class="p">:</span>
<span class="n">tm</span><span class="o">.</span><span class="n">setData</span><span class="p">(</span><span class="n">myData</span><span class="p">);</span>
 <span class="o">//</span> <span class="n">Put</span> <span class="n">the</span> <span class="n">threads</span> <span class="n">works</span> <span class="n">on</span> <span class="n">functionB</span>
 <span class="n">tm</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">functionB</span><span class="p">);</span>
 <span class="p">}</span>
</pre></div>
</div>
<p><strong>Synchronizing threads</strong></p>
<p>Synchronization is vital for almost all parallel programs. We want
things done faster but also we want things done well. Through
synchronization we can guarantee that things are done in the correct
order and provide the same results as if it was done sequentially.</p>
<p>Synchronization between threads is done primarily through mutexes. A
mutex allows to protect a portion of the code so only one thread can
access it at a time. We have created the <em>Mutex</em> class wich encapsulates
the mutex creation, initialization and clean up through the <em>pthreads</em>
library.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Mutex</span> <span class="n">mutexUpdate</span><span class="p">;</span>
<span class="o">//....</span>
<span class="o">//</span> <span class="n">Inside</span> <span class="n">some</span> <span class="n">threaded</span> <span class="n">function</span><span class="p">:</span>
<span class="n">mutexUpdate</span><span class="o">.</span><span class="n">lock</span><span class="p">();</span>
<span class="o">//</span><span class="n">Perform</span> <span class="n">the</span> <span class="n">updated</span>
<span class="n">mutexUpdate</span><span class="o">.</span><span class="n">unlock</span><span class="p">();</span>
</pre></div>
</div>
<p>Other different synchronization structures exist that can adapt better
to different circumstances. For example, a barrier is used when we want
to synchronize a number of threads at a point of the code so no one can
continue working until all of them have reached such point. Barriers are
not always present on all computing platforms. For example, old Unix
implementations do not have such structure defined on the pthreads
library. To avoid problems of this type, a <em>Barrier</em> class have been
implemented base on mutexes. ### Example</p>
<p>¬†Here you will find a complete example of a parallel program using all
the elements together. This example estimate the value of PI. ### Some
Tips</p>
<p>Programming threads is easy‚Ä¶ but debugging threads can be a nightmare.
So take note of these tips:</p>
<ul class="simple">
<li><p>Do not use static variables on threaded code. Such variables are
shared between all threads and can lead to unexpected results.</p></li>
<li><p>Do not use threads for everything. Use them when it is clear they
will represent an advantage. Using too much threads will lead to a
decreared performance.</p></li>
<li><p>Try to create threads once and reuse them. Creating and destroying
threads will represent a slight overhead. On some applications this
can translate into lower performance. (Create just one
<em>[[ThreadManager]]</em> and run several functions )</p></li>
<li><p>Be careful with critical regions and the use of <em>Mutex</em> and
<em>Barrier</em>. A misuse can lead to race conditions(bad results) or
deadlock (program will runs forever)</p></li>
</ul>
<p><strong>Programming with MPI</strong></p>
<p>The Message Passing Interface Standard ( <strong>MPI</strong>) is a message passing
library standard based on the consensus of the MPI Forum, which has over
40 participating organizations, including vendors, researchers, software
library developers, and users. The goal of the Message Passing Interface
is to establish a portable, efficient, and flexible standard for message
passing that will be widely used for writing message passing programs.
As such, MPI is the first standardized, vendor independent, message
passing library. The advantages of developing message passing software
using MPI closely match the design goals of portability, efficiency, and
flexibility. MPI is not an IEEE or ISO standard, but has in fact, become
the ‚Äúindustry standard‚Äù for writing message passing programs on HPC
platforms. You can find more about MPI ¬†here.</p>
<p>We have created some useful classes like <em>[[MpiNode]]</em> that will take
care of some MPI initialization and cleaning. This class also have a
method to synchronize: <em>barrierWait</em> and other utilities. The same
concepts for task distribution can be used with MPI through the
<em>[[MpiTaskDistributor]]</em> class.</p>
<p>A complete example using the MPI tools is available ¬†Here .</p>
<p class="rubric">Google C++ Testing Framework</p>
<p><strong>Summary</strong></p>
<p>Unit testing is a development procedure where programmers create tests
as they develop software. The tests are simple short tests that test
functionality of a particular unit or module of their code, such as a
class or function. Using libraries like gtest these tests can be
automatically run and any problems found quickly. As the tests are
developed in parallel with the source code, when the particular unit is
completed, a successful unit test demonstrates it‚Äôs correctness.</p>
<p>Xmipp incorporates in its code the Google C++ Unit Testing Framework,
<a class="reference external" href="http://code.google.com/p/googletest/">gtest</a> for short (version
1.6). This tutorial explains how you may use this unit testing
framework. ## Basic Concepts</p>
<p>(extract from
<a class="reference external" href="http://code.google.com/p/googletest/wiki/V1_6_Primer#Introduction:_Why_Google_C++_Testing_Framework?">http://code.google.com/p/googletest/wiki/V1_6_Primer#Introduction:_Why_Google_C++_Testing_Framework?)</a>)</p>
<p>When using gtests, you start by writing assertions, which are statements
that check whether a condition is true. An assertion‚Äôs result can be
success, nonfatal failure, or fatal failure. If a fatal failure occurs,
it aborts the current function; otherwise the program continues
normally.</p>
<p>Tests use assertions to verify the tested code‚Äôs behavior. If a test
crashes or has a failed assertion, then it fails; otherwise it succeeds.</p>
<p>A test case contains one or many tests. You should group your tests into
test cases that reflect the structure of the tested code. When multiple
tests in a test case need to share common objects and subroutines, you
can put them into the same test file. ## Assertions</p>
<p>(extract from
<a class="reference external" href="http://code.google.com/p/googletest/wiki/V1_6_Primer#Introduction:_Why_Google_C++_Testing_Framework?">http://code.google.com/p/googletest/wiki/V1_6_Primer#Introduction:_Why_Google_C++_Testing_Framework?)</a>)</p>
<p>Gtest assertions are macros that resemble function calls. You test a
class or function by making assertions about its behavior. When an
assertion fails, gest prints the assertion‚Äôs source file and line number
location, along with a failure message. You may also supply a custom
failure message which will be appended to Google Test‚Äôs message.</p>
<p>The assertions come in pairs that test the same thing but have different
effects on the current function. <a href="#id7"><span class="problematic" id="id8">ASSERT_</span></a>* versions generate fatal
failures when they fail, and abort the current function. <a href="#id9"><span class="problematic" id="id10">EXPECT_</span></a>*
versions generate nonfatal failures, which don‚Äôt abort the current
function. Usually <a href="#id11"><span class="problematic" id="id12">EXPECT_</span></a>* are preferred, as they allow more than one
failures to be reported in a test. However, you should use <a href="#id13"><span class="problematic" id="id14">ASSERT_</span></a>* if
it doesn‚Äôt make sense to continue when the assertion in question fails.</p>
<p>Since a failed <a href="#id15"><span class="problematic" id="id16">ASSERT_</span></a>* returns from the current function immediately,
possibly skipping clean-up code that comes after it, it may cause a
space leak. Depending on the nature of the leak, it may or may not be
worth fixing - so keep this in mind if you get a heap checker error in
addition to assertion errors.</p>
<p>To provide a custom failure message, simply stream it into the macro
using the &lt;&lt; operator. Example:</p>
<p>ASSERT_EQ(x.size(), y.size()) &lt;&lt; ‚ÄúVectors x and y are of unequal
length‚Äù;</p>
<p>for (int i = 0; i &lt; x.size(); ++i) { EXPECT_EQ(x[i], y[i]) &lt;&lt; ‚ÄúVectors x
and y differ at index‚Äù &lt;&lt; i; }</p>
<p>More about assertion is available
<a class="reference external" href="http://code.google.com/p/googletest/wiki/Primer#Assertions">here</a> #
gtest in Xmipp</p>
<p>Xmipp already incorporates gtest natively so you do not need to compile
any extra library. ## General Rules</p>
<ul class="simple">
<li><p>Ideally they should be a test for each routine.</p></li>
<li><p>Test can be found in the directory
$HOME_XMIPP/application/tests/test_className</p></li>
<li><p>Test output must be written in the /tmp directory as temporary files.
These files should be deleted once the test is finished.</p></li>
<li><p>If possible input data should be created on the fly. If some input
file is needed it should be place in
$HOME_XMIPP/resources/test/className</p></li>
<li><p>Test are part of the software development cycle and should be written
BEFORE and not AFTER the creation of new routines.</p></li>
</ul>
<p><strong>Adding a test to an existing file</strong></p>
<p>In this section we will assume that you want to add a test for a class
that has already been incorporated in the test system. Let us assume
that we want to add a test for the metadata class. This test will check
that a function called <em>Factorial(n)</em> that compute the factorial number
of <em>n</em> works properlly.</p>
<ul class="simple">
<li><p>Edit file at
<em>$XMIPP_HOME/pplications/tests/test_metadata/test_metadata_main.cpp</em></p></li>
<li><p>Use the TEST_F() macro to define and name a test function, These are
ordinary C++ functions that don‚Äôt return a value.</p></li>
</ul>
<p>TEST_F() arguments go from general to specific. The first argument is
the name of the test case, and the second argument is the test‚Äôs name
within the test case. Both names must be valid C++ identifiers, and they
should not contain underscore (_).</p>
<p>For example, let‚Äôs take a simple integer function: int Factorial(int n);
// Returns the factorial of n.</p>
<p>A test case for this function might look like:</p>
<p>// Tests factorial of 0. TEST_F(MetadataTest, FactorialHandlesZeroInput)
{ EXPECT_EQ(1, Factorial(0)); }</p>
<p>// Tests factorial of positive numbers. TEST_F(MetadataTest,
FactorialHandlesPositiveInput) { EXPECT_EQ(1, Factorial(1));
EXPECT_EQ(2, Factorial(2)); EXPECT_EQ(6, Factorial(3)); EXPECT_EQ(40320,
Factorial(8)); }</p>
<p>In addition to the code you have written gtest will create a ‚Äúfresh‚Äù
environment each time a particular test_f is executed:</p>
<ul class="simple">
<li><p>First, initialize running the routineSetUp() ,</p></li>
<li><p>Then, execute the test</p></li>
<li><p>After that, clean up by callingTearDown()</p></li>
<li><p>No data structures allocated in memory may be reuse from one test to
the next one</p></li>
</ul>
<p>In the case of <em>metadata</em>, the <em>[[SetUp]]</em> routine creates three basic
metadata and <a href="#id3"><span class="problematic" id="id4">`[TearDown] &lt;&gt;`__</span></a> is not defined. ## Case 2: Create Unit
tests for a new class</p>
<p>In this section we will assume that you want to add a test for a class
that has NOT been incorporated in the test system. Let us create a test
for a class called <em>myPrettyClass</em></p>
<ul class="simple">
<li><p>Create a new directory called
<em>$XMIPP_HOME/application/test/test_myPrettyClass</em></p></li>
<li><p>Create a new file in this directory called
<em>test_myPrettyClass_main.cpp</em></p></li>
<li><p>Edit the <em>test_myPrettyClass_main.cpp</em> file, use the bellow template
for starting</p></li>
<li><p>Edit <em>$XMIPP_HOME/SConscript</em></p></li>
<li><p>Look for the line <a class="reference external" href="'test_fftw'">[AddXmippCTest]</a></p></li>
<li><p>Add the line <a class="reference external" href="'test_myPrettyClass'">[AddXmippCTest]</a> in this
section</p></li>
</ul>
<!-- * Set FORMAT_PREPEND=<style type="text/css"> --><p>#include ‚Äú../../../external/gtest-1.6.0/fused-src/gtest/gtest.h‚Äù</p>
<p>class myPrettyClassTest : public ::testing::Test { protected:</p>
<p>virtual void <a href="#id3"><span class="problematic" id="id5">`[SetUp] &lt;&gt;`__</span></a> { // Code here will be called immediately
after the constructor (right // before each test). }</p>
<p>virtual void <a href="#id3"><span class="problematic" id="id6">`[TearDown] &lt;&gt;`__</span></a> { // Code here will be called immediately
after each test (right // before the destructor). }</p>
<p>// Objects declared here can be used by all tests in the test case for
Foo. };</p>
<p>// Tests that the myPrettyClassTest::Bar() method does Abc.
TEST_F(myPrettyClass, MethodBarDoesAbc) { FileName input_filepath =
‚Äúthis/package/testdata/myinputfile.dat‚Äù; FileName output_filepath =
‚Äúthis/package/testdata/myoutputfile.dat‚Äù; Foo f; EXPECT_EQ(0,
f.Bar(input_filepath, output_filepath)); }</p>
<p>// Tests that Foo does Xyz. TEST_F(myPrettyClass, DoesXyz) { //
Exercises the Xyz feature of Foo. }</p>
<p>GTEST_API_ int main(int argc, char **argv) {
testing::InitGoogleTest(&amp;argc, argv); return RUN_ALL_TESTS(); } ##
Compile and Invoke the Tests</p>
<p>In a few words:</p>
<ul>
<li><p>compile:</p>
<pre> xcompile xmipp_test_myPrettyClass</pre></li>
<li><p>compile and execute:</p>
<pre> xcompile run_test_myPrettyClass</pre></li>
<li><p>execute:</p>
<pre> xmipp_test_myPrettyClass</pre></li>
</ul>
<p>Example of execution of the test <em>xmipp_test_matrix</em> :</p>
<pre>roberto@tumbao:~/xmipp_svn$ xmipp_test_matrix
[==========] Running 4 tests from 1 test case.
[----------] Global test environment set-up.
[----------] 4 tests from [[MatrixTest]]
[ RUN      ] [[MatrixTest]].inverse
[       OK ] [[MatrixTest]].inverse (0 ms)
[ RUN      ] [[MatrixTest]].det3x3
[       OK ] [[MatrixTest]].det3x3 (0 ms)
[ RUN      ] [[MatrixTest]].solveLinearSystem
[       OK ] MatrixTest.solveLinearSystem (0 ms)
[ RUN      ] MatrixTest.initGaussian
[       OK ] MatrixTest.initGaussian (0 ms)
[----------] 4 tests from MatrixTest (1 ms total)

[----------] Global test environment tear-down [==========] 4 tests from 1 test case ran. (1 ms total) [  PASSED  ] 4 tests. roberto@tumbao:~/xmipp_svn$  </pre><p><strong>Unittest checking workflow</strong></p>
<p>When a unittest is generated, sometimes its result is very tied to the
machine where it is generated (some mathematical results depends on the
compiler, libraries that may differ). This may drive the test to a
failure as long as the result in the testing machine could be a little
different from the goldStandard machine. We recommend giving the test a
little tolerance to avoid this false failures. The workflow after a test
is generated is the following:</p>
<p>1 A test is generated, the goldStandard is generated in the owner‚Äôs
machine. 1 The test is uploaded to the repository. 1 That night, tests
will be passed on einstein, and results are sent to the sysadmins. 1 In
case of failure sysadmins check with the owner whether or not it is a
tolerance problem. 1 If it‚Äôs just a tolerance problem, then goldStandard
is regenerated on einstein and owner assume that a failure in that test
in his machine doesn‚Äôt mean a thing. 1 If it‚Äôs not, then the owner takes
the responsability of repairing the test</p>
<p><strong>Setting the gold standard</strong></p>
<p>You may update the gold standard of the tests at the server by doing:</p>
<pre>
bin/xmipp_sync_data update tests/data http://scipion.cnb.csic.es/downloads/scipion/data/tests xmipp_programs
</pre></section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../Guidelines/index.html" class="btn btn-neutral float-left" title="Guidelines" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../CodeDocumentation/index.html" class="btn btn-neutral float-right" title="Code documentation" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Xmipp team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>